<!DOCTYPE html>

<html>

<head>
  <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta http-equiv="Content-Language" content="en" />
    <title>Search Ranks of Presidential Candidates</title>
    <link rel="stylesheet" href="http://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap.min.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>
    <script src="http://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/js/bootstrap.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/3.5.5/d3.min.js"></script>
    <link href='http://fonts.googleapis.com/css?family=Abel' rel='stylesheet' type='text/css'>
</head>


<style>

body {
  font-size: 12px;
  font-family: 'Abel', sans-serif;
  margin-top: 20px;
}

li{
    margin-left: 0px;
    }

.x.axis path,.x.axis line {
    fill: none;
    stroke: none;
    }

.y.axis path {
    fill: none;
    }

.y.axis line {
    fill: none;
    stroke: #eeeeee;
    shape-rendering: crispEdges;
    }

.x.axis text, .y.axis text{
      font-size: 10px;
      fill:grey;
    }

.line {
  fill: none;
  stroke-width: 2px;
}

.tick line{
    stroke: #e0e1e1;
    opacity: 1;
    }

#title, .explain{
      text-indent: 15px;
    }

#credit{
      color:grey;
      text-indent: 20px;
      line-height: 30px;
    }

 a:hover{
      cursor:pointer;
    }


</style>


<body>

<h1 id="title">Climate Change Forces</h1>
<p class="explain"> · Click on a button in dropdown menus to see the search interest changes from 1850 to 2005.</p>
<p class="explain"> · Hover over a force's name tag to see the search interest trend of it. </p>
<p class="explain"> · Click on the Replay Button to replay the change of forces.</p>

<div class="bs-example">
    <ul class="nav nav-pills" role="tablist">
      <li role="presentation" class="dropdown">
        <a id="drop4" data-target="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false">
          Natural
          <span class="caret"></span>
        </a>
        <ul id="menu1" class="dropdown-menu" aria-labelledby="drop4">
         <!--  <li id="democrats"><a data-target="#">All Democrats</a></li>
          <li role="separator" class="divider"></li> -->
          <li class="forcename"><a data-target="#">Natural</a></li>
          <li class="forcename"><a data-target="#">Orbital changes</a></li>
          <li class="forcename"><a data-target="#">Ozone</a></li>
          <li class="forcename"><a data-target="#">Solar</a></li>
          <li class="forcename"><a data-target="#">Volcanic</a></li>
        </ul>
      </li>

      <li role="presentation" class="dropdown">
        <a id="drop5" data-target="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false">
          Human
          <span class="caret"></span>
        </a>
        <ul id="menu2" class="dropdown-menu" aria-labelledby="drop5">
        <!--   <li id="republicans"><a data-target="#">All Republicans</a></li>
           <li role="separator" class="divider"></li> -->
          <li class="forcename"><a data-target="#">Human</a></li>
          <li class="forcename"><a data-target="#">Anthropogenic tropospheric aerosol</a></li>
          <li class="forcename"><a data-target="#">Greenhouse gases</a></li>
          <li class="forcename"><a data-target="#">Land use</a></li>
        </ul>
      </li>
      <li role="presentation" class="active" id="replay"><a data-target="#">Replay</a></li>
    </ul>
  </div>

<div id="graphic"></div>



<script src="http://d3js.org/d3.v3.js"></script>

<script>

function drawGrahpics(){

var margin = {top: 90, right: 120, bottom: 30, left: 50},
    width = 1200 - margin.left - margin.right,
    height = 700 - margin.top - margin.bottom;

var speed = 600;

var dateFormat = d3.time.format("%Y");

var x = d3.scale.linear()
    .range([0, width]);

var y = d3.scale.linear()
    .range([height, 0]);

var color = d3.scale.category10();


var xAxis = d3.svg.axis()
    .scale(x)
    .tickSize(0)
    .ticks(30)
    .orient("top");
// var xtickLabels = ["1850","2005"];
var xtickLabels = ["1850", "1851", "1852", "1853", "1854", "1855", "1856", "1857", "1858", "1859", "1860", "1861", "1862", "1863", "1864",
"1865", "1866", "1867", "1868", "1869", "1870", "1871", "1872", "1873", "1874", "1875", "1876", "1877", "1878", "1879", "1880", "1881", "1882",
"1883", "1884", "1885", "1886", "1887", "1888", "1889", "1900", "1901", "1902", "1903", "1904", "1905", "1906", "1907", "1908", "1909", "1910",
"1911", "1912", "1913", "1914", "1915", "1916", "1917", "1918", "1919", "1920", "1921", "1922", "1923", "1924", "1925", "1926", "1927", "1928",
"1929", "1930", "1931", "1932", "1933", "1934", "1935", "1936", "1937", "1938", "1939", "1940", "1941", "1942", "1943", "1944", "1945", "1946",
"1947", "1948", "1949", "1950", "1951", "1952", "1953", "1954", "1955", "1956", "1957", "1958", "1959", "1960", "1961", "1962", "1963", "1964",
"1965", "1966", "1967", "1968", "1969", "1970", "1971", "1972", "1973", "1974", "1975", "1976", "1977", "1978", "1979", "1980", "1981", "1982",
"1983", "1984", "1985", "1986", "1987", "1988", "1989", "1990", "1991", "1992", "1993", "1994", "1995", "1996", "1997", "1998", "1999", "2000",
"2001", "2002", "2003", "2004", "2005"];

xAxis.tickFormat(function(d,i){
    return dateFormat.parse(xtickLabels[i]);
  });

var yAxis = d3.svg.axis()
    .scale(y)
    .tickFormat(function(d) { return d;})
    .ticks(16)
    .innerTickSize(-width)
    .tickPadding(10)
    .outerTickSize(0)
    .orient("left");


var line = d3.svg.line()
    .x(function(d) { return x(d.year); })
    .y(function(d) { return y(d.amount); });


var svg = d3.select("#graphic").append("svg")
    .attr("width", width + margin.left + margin.right)
    .attr("height", height + margin.top + margin.bottom)
    .call(responsivefy)
    .append("g")
    .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

var clip = svg.append("clipPath")
    .attr("id", "clip")
    .append("rect")
    .attr("x","-5")
    .attr("y","-20")
    .attr("width", 0)
    .attr("height", height*1.2);

d3.csv("data/forcings.csv", function(error, data) {

  color.domain(d3.keys(data[0]).filter(function(key) { return key !== "year"; }));

  data.forEach(function(d) {
    d.year = +[d.year];
  });


  var forces = color.domain().map(function(name) {
    return {
      name: name,
      values: data.map(function(d, i) {
        return {name:name, year: d.year, counter: i, amount: +d[name]};
      })
    };
  });

// parse as years
  x.domain(d3.extent(xtickLabels, function(d) {
    return dateFormat.parse(d);
  }));


  y.domain([
    d3.min(forces, function(c) { return d3.min(c.values, function(v) { return v.amount ; }); }),
    d3.max(forces, function(c) { return d3.max(c.values, function(v) { return v.amount ; }); })
  ].reverse());


svg.append("g")
      .attr("class", "x axis")
      .attr("transform","translate(0,0)")
      .call(xAxis)
      .selectAll("text")
      .style("text-anchor","start")
      .attr("dx", "2.3em")
      .attr("dy", "-0.9em");
      // .attr("transform",function(d){
      //   return "rotate(-60)"});

  svg.append("g")
      .attr("class", "y axis")
      .call(yAxis)

  //timeline
  svg.append("line")
        .attr(
        {
            "class":"horizontalGrid",
            "x1" : -2,
            "x2" : width,
            "y1" : y(1) - 13,
            "y2" : y(1) - 13,
            "fill" : "none",
            "shape-rendering" : "crispEdges",
            "stroke" : "#e0e1e1",
            "stroke-width" : "1px",
            "stroke-dasharray": ("3, 3")
        })
        .attr("id","dotted")
        .attr("clip-path", function(d) { return "url(#clip)"; });




  //end of timeline



  var forces = svg.selectAll(".force")
      .data(forces)
    .enter().append("g")
      .attr("class", "force");


 function colorFilter(d){
    if (d.name === "Human") {
          return "#7183d3";
      } else if (d.name === "Anthropogenic tropospheric aerosol") {
          return "#7183d3";
      } else if (d.name === "Greenhouse gases"){
        return "#7183d3";
      } else if (d.name === "Land use"){
        return "#7183d3";
      } else if (d.name === "Natural"){
        return "#7183d3";
      }else {
          return "#ce3b69";}
    }

  var path = svg.selectAll(".force").append("path")
      .attr("class", "line")
      .attr("d", function(d) { return line(d.values); })
      .attr("clip-path", function(d) { return "url(#clip)"; })
      .style("stroke", colorFilter)



var circleStart = forces.append("circle")
      .attr("cx", "0")
      .attr("cy", function(d) { return y(d.values[0].amount); })
      .style("fill", colorFilter)
      .attr("r", 2)



var circleEnd = forces.append("circle")
      .attr("cx", function(d) { return x(d.values[0].year); })
      .attr("cy", function(d) { return y(d.values[0].year);} )
      .style("fill", colorFilter)
      .attr("r", 2);


var timemark = forces.append("path")
                  .attr("d", d3.svg.symbol().type("triangle-up"))
                  .style("fill", "grey")
                  .attr("transform",function(d) { return "translate(" + (x(dateFormat.parse(d.values[0].year))) + "," + (y(1)-15) + ") rotate(-30)"; })


var round = forces.append("circle")
      .attr("transform", function(d) { return "translate(" + (x(dateFormat.parse(d.values[0].year) + 15)) + "," + (y(d.values[0].amount)) + ")"; })
      .attr("x", 0)
      .attr("y",0)
      .attr("r", 10)
      .on("mouseover", function (d) {
        forces.style("opacity",0.1);
        forces.filter(function(path) {return path.name === d.name; }).style("opacity",1);
      })
      .on("mouseout", function (d) { forces.style("opacity",1); })
      .style("fill", colorFilter);


  var amounting = forces.append("text")
      .attr("transform", function(d) { return "translate(" + (x(dateFormat.parse(d.values[0].year) + 15 )) + "," + (y(d.values[0].amount) ) + ")"; })
      .attr("x", 0)
      .attr("dy", ".31em")
      .attr("text-anchor","middle")
      .on("mouseover", function (d) {
        forces.style("opacity",0.1);
        forces.filter(function(path) {return path.name === d.name; }).style("opacity",1);
      })
      .on("mouseout", function (d) { forces.style("opacity",1); })
      .style("cursor","pointer")
      .style("fill", "#ffffff")
      .style("font-weight", "bold")
      .text(function(d) { return d.values[0].amount; });


  var label = forces.append("text")
  //parse
      .attr("transform", function(d) { return "translate(" + (x(dateFormat.parse(d.values[0].year) + 20)) + "," + (y(d.values[0].amount) ) + ")"; })
      .attr("x", 8)
      .attr("dy", ".31em")
      .attr("id","label")
      .on("mouseover", function (d) {
        forces.style("opacity",0.1);
        forces.filter(function(path) {return path.name === d.name; }).style("opacity",1);
      })
      .on("mouseout", function (d) { forces.style("opacity",1); })
      .style("cursor","pointer")
      .style("stroke", colorFilter)
      .text(function(d) { return d.name; });




  var year = 0;

  var transition = d3.transition()
    .delay(500)
    .duration(speed)
    .each("start", function start() {

      label.transition()
        .duration(speed)
        .ease('linear')
        //parse
      .attr("transform", function(d) { return "translate(" + (x(dateFormat.parse(d.values[year].year) + 20)) + "," + (y(d.values[year].year)) + ")"; })
      .text(function(d) { return  d.name; });

      amounting.transition()
        .duration(speed)
        .ease('linear')
        .attr("transform", function(d) { return "translate(" + (x(dateFormat.parse(d.values[year].year) + 15)) + "," + (y(d.values[year].amount) ) + ")"; })
      .text(function(d,i) { return  d.values[year].amount; });

      round.transition()
        .duration(speed)
        .ease('linear')
        .attr("transform", function(d) { return "translate(" + (x(dateFormat.parse(d.values[year].year) + 15)) + "," + (y(d.values[year].amount)) + ")"; });

      circleEnd.transition()
        .duration(speed)
        .ease('linear')
        .attr("cx", function(d) { return x(dateFormat.parse(d.values[year].year)); })
        .attr("cy", function(d) { return y(d.values[year].amount); });

      clip.transition()
        .duration(speed)
        .ease('linear')
        .attr("width", x(year+1)+5)
        .attr("height", height*1.2);

      timemark.transition()
         .duration(speed)
         .ease('linear')
         .attr("transform",function(d) { return "translate(" + (x(dateFormat.parse(d.values[year].year) )) + "," + (y(1)-15) + ") rotate(-30)"; })


      year+=1;


      if (year !== data[0].length){

        transition = transition.transition().each("start", start);}
      });



  // combined function for each candidate
  // ids are not necessary (just use jquery selector)
    $(".forcename").on("click",function(){
      // get the name of the candidate the user clicked on
      var nameOfForce = $(this).text();
      // use d3 to change the style of all except for the clicked one
        forces.style("opacity",0.1);
        forces.filter(function(path) {
          return path.name === nameOfForce;
        }).style("opacity",1);
      });




   });









      function responsivefy(svg) {

        var container = d3.select(svg.node().parentNode),
            width = parseInt(svg.style("width")),
            height = parseInt(svg.style("height")),
            aspect = width / height;

        svg.attr("viewBox", "0 0 " + width + " " + height)
            .attr("perserveAspectRatio", "xMinYMid")
            .call(resize);

        d3.select(window).on("resize." + container.attr("#graphic"), resize);

        function resize() {
            var targetWidth = parseInt(container.style("width"));
            svg.attr("width", targetWidth * 0.8);
            svg.attr("height", Math.round(targetWidth /aspect * 0.8));
        }
    }

}

</script>

</body>

<script>

drawGrahpics()

d3.select("#replay")
    .on("click", function(){
      location.reload()
    })


</script>

</html>
