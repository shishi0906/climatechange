<html lang="en">
  <head>
    <meta charset="utf-8">
<title>Health Bar Chart</title>
<style>
    body {
      background: #fcfcfa;
      color: #333;
      margin: 1em auto 4em auto;
      position: relative;
      width: 950px;
    }
    .p {
      font-family: arial, georgia, sans-serif;
      font-size: 1em;
      position:relative
    }
    svg {
      font: 10px sans-serif;
      padding-left:60px;
    }
    .bar rect {
      fill: steelblue;
    }
    .bar rect:hover {
      fill: #A52A2A;
    }
    .value {
      fill: white;
    }
    .axis {
      shape-rendering: crispEdges;
    }
    .axis path {
      fill: none;
      stroke: none;
    }
    .x.axis path {
      fill: none;
      stroke: white;
    }
    .x.axis line {
      stroke: #fff;
      stroke-opacity: .8;
    }
    .y.axis path {
      stroke: black;
    }
</style>
</head>

<body>

<h1>Health Care in Different Countries (TOP 10)</h1>
<p>
Improving health is central to the Millennium Development Goals, and the public sector is the main provider of health care in different countries. To reduce inequities, many countries have emphasized primary health care, including immunization, sanitation, access to safe drinking water, and safe motherhood initiatives. Data here cover health expenditure and various disease prevalence in 2013. Data are from the United Nations Population Division, World Health Organization, United Nations Children's Fund, the Joint United Nations Programme on HIV/AIDS, and various other sources.</p>


<p>Source of original: <a href="http://data.worldbank.org/topic/health">WorldBank</a></p>



<div id="menu">
        <select>
        <option value="year1990">1990</option>
        <option value="year1995">1995</option>
        <option value="year2000">2000</option>
        <option value="year2005">2005</option>
        <option value="year2010">2010</option>



        </select>
    </div>

<p id="chart"></p>

<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/d3/3.5.6/d3.min.js"></script>
<script>
  var fullwidth = 960,
    fullheight = 280;
  var margin = {top: 20, right: 40, bottom: 10, left: 40},
      width = fullwidth - margin.right - margin.left;
      height = fullheight - margin.top - margin.bottom;
  var countries,
      prevColumn;
  var xScale = d3.scale.linear()
      .range([0, 700]);
  var yScale = d3.scale.ordinal()
      .rangeRoundBands([0, height], .1);
  var xAxis = d3.svg.axis()
      .scale(xScale)
      .orient("top")
      .tickFormat();
  var svg = d3.select("#chart").append("svg")
      .attr("width", fullwidth)
      .attr("height", fullheight)
      .style("margin-left", -margin.left + "px")
      .append("g")
      .attr("transform", "translate(" + margin.left + "," + margin.top + ")");
  svg.append("g")
      .attr("class", "x axis");
  svg.append("g")
      .attr("class", "y axis")
    .append("line")
      .attr("class", "domain")
      .attr("y2", height);
  var menu = d3.select("#menu select")
      .on("change", redraw);
  d3.csv("data/emission.csv", function(data) {
    countries = data;
    // remember d3.keys gets us the column names from these objects, using first row:
    var columns = d3.keys(countries[0]).filter(function(key) {
      return key != "country"; // this will return columns NOT MATCHING those
    });
    console.log(columns);
    // do some calculations for each percentage
    countries.forEach(function(country) {
      columns.forEach(function(column) {
        country[column] = country[column];
      });
    });
  // build menu from the data; could have been done by hand.
    menu.selectAll("option")
        .data(columns)
      .enter().append("option")
        .text(function(d) { return d; });
    menu.property("value", "year1990");
    // redraw in this case draws the UI - it uses a variable to determine data column.
    redraw();
  }); // end load csv
  function redraw() {
    // get the age for the data access off the menu:
    var currentColumn = menu.property("value");
      // sort by it and then take the top 10 using slice!
    var top10 = countries.sort(function(a, b) {
            return b[currentColumn] - a[currentColumn];
          })
          .slice(0, 10);
    yScale.domain(top10.map(function(d) { return d.country; })); // the y scale is ordinal, all the state names
    var bar = svg.selectAll(".bar")
        .data(top10, function(d) { return d.country; }); // key function!
    var barCreate = bar.enter().append("g")
        .attr("class", "bar")
        .attr("transform", function(d) { return "translate(0," + (yScale(d.country) + height) + ")"; })
        .style("fill-opacity", 0);
    console.log("age", prevColumn); // this is undefined the first time thru.
    barCreate.append("rect")
        //.attr("width", age && function(d) { return x(d[age]); })
        .attr("width", function(d) {
          if (prevColumn) {
            return xScale(d[prevColumn]);
          }
        })
        .attr("height", yScale.rangeBand())
        .style("fill", function(d){
          if (d.country === "China") {
            return "#80AEBD"; // special case file, could have been done by a class.
          }
        });
    barCreate.append("text")
        .attr("class", "label")
        .attr("x", -3)
        .attr("y", yScale.rangeBand() / 2)
        .attr("dy", ".35em")
        .attr("text-anchor", "end")
        .text(function(d) { return d.country; });
    barCreate.append("text")
        .attr("class", "value")
        //.attr("x", age && function(d) { return x(d[age]) - 3; })
        .attr("x", function(d) {
          if (prevColumn) {
          return xScale(d[prevColumn]) - 3;
          }
        })
        .attr("y", yScale.rangeBand() / 2)
        .attr("dy", ".35em")
        .attr("text-anchor", "end");
    prevColumn = currentColumn;
    // they are sorted, so take the top value for the max on the domain here:
    xScale.domain([0, top10[0][currentColumn]]);
    // sets the d.yLocation for the bar that's used in the exit transition.
    var barUpdate = bar.transition()
        .attr("transform", function(d) {
          // set the value of the current y location for the exit move when it goes.
          d.yLocation = yScale(d.country);
          return "translate(0," + yScale(d.country) + ")"; })
        .style("fill-opacity", 1);
    barUpdate.select("rect")
        .attr("width", function(d) { return xScale(d[currentColumn]); });
    barUpdate.select(".value")
        .attr("x", function(d) { return xScale(d[currentColumn]) - 3; })
        .text(function(d) { return d[currentColumn]; });
    var barExit = bar.exit().transition()
        .attr("transform", function(d) { return "translate(0," + (d.yLocation + height) + ")"; })
        .style("fill-opacity", 0)
        .remove();
    barExit.select("rect")
        .attr("width", function(d) { return xScale(d[currentColumn]); });
    barExit.select(".value")
        .attr("x", function(d) { return xScale(d[currentColumn]) - 3; })
        .text(function(d) { return d[currentColumn]; });
        // transition the axis, so easy if you fixed the domain!
    svg.transition().select(".x.axis")
        .call(xAxis);
  }
</script>

</body>
</html>
